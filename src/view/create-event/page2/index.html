<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/create-event/page2/style.css" />
    <script defer src="../../script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Crear evento</title>
</head>
<body>
    <div class="container">
        <div class="main-box">
            <!-- Category Section -->
            <div class="category-section">
                <div class="category-label">Categoría</div>
                <input class="category-box" type="text" id="category" placeholder="Ej. Concierto" />
            </div>

            <!-- Capacity Section -->
            <div class="capacity-section">
                <div class="capacity-label">Capacidad</div>
                <input class="capacity-input" id="capacity" id="price" placeholder="100" type="number"  min="0" max="1000000000" />
            </div>

            <!-- Status Section -->
            <div class="status-section">
                <div class="status-label">Estado</div>
                <select class="status-box" id="status">
                    <option value="Activo">Activo</option>
                    <option value="Agotado">Agotado</option>
                    <option value="Próximamente">Proximamente</option>
                </select>
            </div>

            <!-- Price Section -->
            <div class="price-section">
                <div class="price-label">Precio</div>
                <input class="price-input" id="price" type="number" min="0" max="1000000000" step=".01" placeholder="0.00" pattern="^\d+(?:\.\d{1,2})?$" /> 
            </div>

            <!-- Image Section -->
            <label class="upload-file">
                <div class="upload-text">Imagen del Evento: </div>
            </label>
            
            <div class="image-section">
                <input type="file" id="image-file" accept="image/*" />
            </div>

            <!-- Create Event Title -->
            <div class="create-event-title">Crear evento</div>

            <!-- Create Button -->
            <button class="create-button" onclick="createEventNEW()">Crear</button>

            <button class="cancel-button" onclick="goToAdminPanel()">Cancelar</button>

            <!-- Icons Section -->
            <div class="icons">
                <div class="icon-1">
                    <img alt="Home" src="/create-event/page2/../../global_assets/logout.svg">
                </div>
                <div class="icon-2">
                    <img alt="User" src="/create-event/page2/../../global_assets/user.svg">
                </div>
                <div class="icon-3">
                    <img alt="Log out" src="/create-event/page1/../../global_assets/home.svg">
                </div>
            </div>

        </div>
    </div>

    <script>
        function isValidNumber(input, options = {}) {
            const defaults = {
                min: null,
                max: null,
                maxDecimals: 2,
                decimalSeparator: '.',
                fieldName: 'Este campo',
                required: true
            };
            const config = { ...defaults, ...options };

            let str = String(input).trim().replace(',', '.');

            if (isNaN(str) || isNaN(parseFloat(str)) || str.split('.').length >= 3) {
                return {
                    isValid: false,
                    message: `${config.fieldName} debe ser un número válido (no use comas [,] y que sea un numero)`,
                    cleanValue: null
                };
            }

            if (config.required && (input === '' || input === null || input === undefined)) {
                return {
                    isValid: false,
                    message: `${config.fieldName} es requerido`,
                    cleanValue: null
                };
            }

            if (!config.required && (input === '' || input === null || input === undefined)) {
                return { 
                    isValid: true,
                    cleanValue: null
                };
            }

            const num = parseFloat(str);
            let cleanValue = num;

            // Check decimal places
            const decimalPart = str.split('.')[1];
            if (decimalPart && decimalPart.length > config.maxDecimals) {
                return {
                    isValid: false,
                    message: `${config.fieldName} debe tener máximo ${config.maxDecimals} decimales`,
                    cleanValue: null
                };
            }

            // Check minimum value
            if (config.min !== null && num < config.min) {
                return {
                    isValid: false,
                    message: `${config.fieldName} debe ser mayor o igual a ${config.min}`,
                    cleanValue: null
                };
            }

            // Check maximum value
            if (config.max !== null && num > config.max) {
                return {
                    isValid: false,
                    message: `${config.fieldName} debe ser menor o igual a ${config.max}`,
                    cleanValue: null
                };
            }

            return {
                isValid: true,
                cleanValue: config.maxDecimals === 0 ? Math.round(num) : num,
                message: ''
            };
        }
        
        async function createEventNEW() {
            // Obtener valores del formulario
            const category = document.getElementById('category').value;
            const capacity = document.getElementById('capacity').value;
            const status = document.getElementById('status').value;
            const price = document.getElementById('price').value;
            const imageFile = document.getElementById('image-file').files[0];



            const eventInfo = JSON.parse(localStorage.getItem('eventData'));
            if (!eventInfo) {
                Swal.fire({ icon: "error", text: 'Datos del evento incompletos' });
                return;
            }

            // Enhanced number validations
            const capacityValidation = isValidNumber(capacity, {
                min: 1,
                max: 100000,
                maxDecimals: 0,
                fieldName: 'Capacidad'
            });

            const priceValidation = isValidNumber(price, {
                min: 0,
                max: 1000000,
                maxDecimals: 2,
                fieldName: 'Precio'
            });

            // Show validation errors if any
            if (!capacityValidation.isValid) {
                Swal.fire({ icon: "error", text: capacityValidation.message });
                return;
            }

            if (!priceValidation.isValid) {
                Swal.fire({ icon: "error", text: priceValidation.message });
                return;
            }

            // Validación text / img
            if (!category || !status || !imageFile || !price || !capacity) {
                Swal.fire({ icon: "error", text: 'Por favor complete todos los campos. Ademas, asegurese de usar el formato adecuado...' });
                return;
            }

            const formData = new FormData();
            formData.append('image', imageFile); // NO TOCAR (Mnnnnn....)
            formData.append('name', eventInfo.name);
            formData.append('description', eventInfo.description);
            formData.append('date', eventInfo.date);
            formData.append('time', eventInfo.time);
            formData.append('location', eventInfo.location);
            formData.append('capacity', capacity);
            formData.append('price', price);
            formData.append('status', status);
            formData.append('category', category);
            formData.append('cupo', capacity);

            try {
                const response = await fetch('/api/createAevent', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success === false) {
                    throw new Error(data.message || 'Error en la solicitud');
                }

                Swal.fire({ icon: "success", text: 'Evento creado exitosamente' });
                window.location.href = '/admin/';
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({ 
                    icon: "error", 
                    text: error.message || 'Error al crear el evento' 
                });
            }
        }
    </script>
</body>
</html>
